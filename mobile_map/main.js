var map=new AMap.Map("container",{resizeEnable:!0,zoom:16});function showMask(e){$("#mask").css("height",$(document).height()),$("#mask").css("width",$(document).width()),$(".mask_content").html(e),$("#mask_button").show(),$("#mask").show()}function hideMask(){$("#mask_button").hide(),$("#mask").hide()}function show_hide(e,o){showMask(e),setTimeout(hideMask,o)}$("#keyword").on("input",function(e){$(".detail").css("display","none")}),showMask();var geocoder=new AMap.Geocoder,geolocation=new AMap.Geolocation({enableHighAccuracy:!0,showCircle:!0,showMarker:!0,showButton:!1,timeout:5e3});function getCity(e){return new Promise(function(o,t){var a="";AMap.service("AMap.Geocoder",function(){(geocoder=new AMap.Geocoder({city:""})).getAddress(e,function(e,t){"complete"===e&&"OK"===t.info?(a=t.regeocode.addressComponent.city||t.regeocode.addressComponent.province,o(a)):show_hide("该地区暂不支持",2e3)})})})}function ajaxCity(e,o,t){getCity(t).then(function(t){$.ajax({url:"http://101.201.108.106:8127/findAdminStroe?city="+t,dataType:"json",success:function(t){var a=t.data,n=[];a.map(function(e,o){n.push([e.longitude,e.latitude])});for(var i,s=function(t,s){s=new AMap.Marker({position:n[t],map:map,icon:new AMap.Icon({image:"./images/result.png",size:new AMap.Size(40,45),imageSize:new AMap.Size(40,45)})}),p=new AMap.Walking({map:map,autoFitView:!0}),s.on("click",function(i){console.log(n[t]),$(".detail").css("display","block"),p.clear();var s=n[t][0],c=n[t][1];console.log(e,o,s,c),$(".storeName div>.title").html(a[t].name),$(".location").html(a[t].address),$(".storeName .phone").attr("href","tel:"+a[t].phone),p.search([e,o],[s,c]),$(".storeName .map").click(function(){p.searchOnAMAP({origin:[e,o],destination:[s,c]})})}),map.add(s),i=s},c=0;c<n.length;c++){var p;s(c,i)}}})})}function onComplete(e){hideMask();var o=Math.abs(e.position.lng),t=Math.abs(e.position.lat);ajaxCity(o,t,[o,t])}function onError(e){-1!==e.message.indexOf("Geolocation permission denied.")?show_hide("<p>定位失败！</p>请打开浏览器定位权限",2500):show_hide("<p>无法获取精确位置</p>请尝试刷新或搜索",2500),onLocateFailed()}map.addControl(geolocation),geolocation.getCurrentPosition(),AMap.event.addListener(geolocation,"complete",onComplete),AMap.event.addListener(geolocation,"error",onError);var onLocateFailed=function(){geolocation.getCityInfo(function(e,o){map.setZoom(14)})},onLocateSuccess=function(e){var o=e.addressComponent.city,t=e.addressComponent.province,a=e.addressComponent.district,n=e.addressComponent.township;showOriginAddress(e.formattedAddress.replace(t,"").replace(o,"").replace(a,"").replace(n,"")),origin.position=e.position,placeSearch.setCity(e.addressComponent.citycode),autoComplete.setCity(e.addressComponent.citycode)},searchInput=document.getElementById("keyword"),city="",autoComplete=new AMap.Autocomplete({input:searchInput,citylimit:!0,noshowDistrict:!0}),placeSearch=new AMap.PlaceSearch({map:map});function select(e){map.clearMap();var o=e.poi.location.lng,t=e.poi.location.lat,a=[o,t];if(e.poi&&e.poi.location){map.setZoom(13),map.setCenter(e.poi.location);var n=new AMap.Marker({position:new AMap.LngLat(e.poi.location.lng,e.poi.location.lat)});map.add(n),ajaxCity(o,t,a)}}$("#searchButton").click(function(){placeSearch.search(searchInput.value,function(e,o){if("complete"===e){map.clearMap();var t=o.poiList.pois[0].location,a=t.lng,n=t.lat,i=[a,n];map.setZoom(13),map.setCenter(t);var s=new AMap.Marker({position:new AMap.LngLat(t.lng,t.lat)});map.add(s),ajaxCity(a,n,i)}else show_hide("<p>搜索地点不存在,</p><p>请更换搜索关键词</p>",2e3)})}),AMap.event.addListener(autoComplete,"select",select);